# BiNI Test: Fig8 Wall Relief

This document summarizes the test results for **Bilateral Normal Integration (BiNI)** applied to the **Fig8 Wall Relief** dataset.

---

## 1. Input Files

**Normal Map**  
![Normal Map](data/Fig8_wallrelief/normal_map.png)

**Mask (White image)**  
![Mask](data/Fig8_wallrelief/mask.png)

---

## 2. Command to Run Integration

```bash
python bilateral_normal_integration_numpy.py --path data/Fig8_wallrelief/
```

---

## 3. Output from Integration

**u-direction Weights**  
![u-d](data/Fig8_wallrelief/wu_k_2.png)

**v-direction Weights**  
![v-d](data/Fig8_wallrelief/wv_k_2.png)

**Integrated Depth Map (Pixel Units, Normalized Grayscale)**  
Generated by running bilateral normal integration on the input normal map, saving the raw depth (`z_pix.npy`), and normalizing values to 0–255 for visualization.  
Produced after changes in [commit 8e735c6](https://github.com/MrzAhmadi/bilateral_normal_integration_testing/commit/8e735c67aeba2b0bc1a9c0b0050d3c3c1de33968).

![Integrated Depth Map](data/Fig8_wallrelief/z_pix.png)

---

## 4. Depth Evaluation (Ground Truth Normals)

**Unit Conversions**
- **GT (16-bit) → mm:**  
  `mm_per_gt_unit = 5000 / 65535 = 0.0762951095 mm/unit`
- **Integrated depth (pixels) → mm:**  
  `mm_per_pixel = 4000 / 512 = 7.8125 mm/pixel`

**Alignment Details**
- Sign flipped: **Yes**
- Applied zero offset: **4849.739258 mm** (~4.85 m)

**Metrics (GT Normals)**
| Metric | Value (mm) | Value (px) |
|---|---:|---:|
| MAE | **733.578369** | **93.898031** |
| RMSE | **915.681335** | **117.207211** |

**Visual Results**
| Ground Truth | Aligned Estimate | Absolute Error (mm) |
|---|---|---|
| ![GT](data/Fig8_wallrelief/eval_results/gt_mm_norm.png) | ![Estimate](data/Fig8_wallrelief/eval_results/est_mm_aligned_norm.png) | ![Error](data/Fig8_wallrelief/eval_results/error_mm_abs.png) |

---

## 5. Photometric Stereo Evaluation

We also tested the pipeline using **normals estimated via Photometric Stereo (PS)** instead of ground-truth normals.  
The script [`photometric_stereo.py`](photometric_stereo.py) (located in the root of the repository) was added for this purpose.

**Integrated Depth Map**  
![Integrated Depth Map](data/Fig8_wallrelief_ps/z_pix.png)

### Commands

```bash
python photometric_stereo.py   --images_dir data/Fig8_wallrelief/material_4   --lights data/Fig8_wallrelief/lights.txt   --mask data/Fig8_wallrelief/mask.png   --shadows_dir data/Fig8_wallrelief/shadows   --out_dir data/Fig8_wallrelief_ps   --copy_from data/Fig8_wallrelief

python bilateral_normal_integration_numpy.py --path data/Fig8_wallrelief_ps

python evaluate_depth_error.py --path data/Fig8_wallrelief_ps
```

### Metrics (PS Normals)
| Metric | Value (mm) | Value (px) |
|---|---:|---:|
| MAE | **667.974182** | **85.500695** |
| RMSE | **892.293030** | **114.213508** |

### Visual Results (PS Normals)
| Ground Truth | Aligned Estimate | Absolute Error (mm) |
|---|---|---|
| ![GT](data/Fig8_wallrelief_ps/eval_results/gt_mm_norm.png) | ![Estimate](data/Fig8_wallrelief_ps/eval_results/est_mm_aligned_norm.png) | ![Error](data/Fig8_wallrelief_ps/eval_results/error_mm_abs.png) |

---

## 6. Reproducibility

```bash
# Run integration to generate z_pix.npy
python bilateral_normal_integration_numpy.py --path data/Fig8_wallrelief

# Evaluate depth against ground truth
python evaluate_depth_error.py --path data/Fig8_wallrelief

# Photometric Stereo case
python photometric_stereo.py   --images_dir data/Fig8_wallrelief/material_4   --lights data/Fig8_wallrelief/lights.txt   --mask data/Fig8_wallrelief/mask.png   --shadows_dir data/Fig8_wallrelief/shadows   --out_dir data/Fig8_wallrelief_ps   --copy_from data/Fig8_wallrelief

python bilateral_normal_integration_numpy.py --path data/Fig8_wallrelief_ps
python evaluate_depth_error.py --path data/Fig8_wallrelief_ps
```